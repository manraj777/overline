FROM node:20-alpine

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy everything from monorepo root (Railway builds from repo root)
COPY . .

# Install all dependencies
RUN pnpm install --frozen-lockfile

# Generate Prisma client and build backend
WORKDIR /app/apps/backend
RUN pnpm exec prisma generate
RUN pnpm run build

# Verify dist exists
RUN ls -la dist/

# Expose port
EXPOSE 3000

# Start the application
CMD ["node", "dist/main.js"]
